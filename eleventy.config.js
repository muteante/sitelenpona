import { HtmlBasePlugin } from "@11ty/eleventy";
import markdownItContainer from 'markdown-it-container';
import markdownItAttrs from 'markdown-it-attrs';

export default async function (eleventyConfig) {
    eleventyConfig.addPassthroughCopy("assets/");
    eleventyConfig.addPlugin(HtmlBasePlugin);
    eleventyConfig.amendLibrary("md", (md) => {
        md.use(markdownItAttrs);
        md.use(markdownItContainer, 'attr', {
            render(tokens, idx, options, env, renderer) {
                let token = tokens[idx];
                if (token.type == 'container_attr_open') {
                    let level = 0;
                    for (let inner = idx + 1; tokens[inner].type != 'container_attr_close'; inner++) {
                        level += tokens[inner].nesting;
                        if (tokens[inner].nesting == 1 && level == 1) {
                            for (let attr of token.attrs) {
                                tokens[inner].attrPush(attr);
                            }
                        }
                    }
                }
                return '';
            }
        });
    });


    eleventyConfig.addFilter("nnp", async function (nanpa) {
        var nanpas = parseInt(nanpa.toString().split(".")[0]);
        var sulinanpa = Math.floor((nanpas.toString().length - 1) / 2);
        var nanpai = nanpas;
        var nanpanimi = "";

        for (var i = sulinanpa; i >= 0; i--) {
            var nanpac = (nanpai - nanpai % (100 ** i)) / (100 ** i);
            nanpanimi += "mute ".repeat(Math.floor(nanpac / 20))
                + "luka ".repeat(Math.floor((nanpac % 20) / 5))
                + "tu ".repeat(Math.floor((nanpac % 5) / 2))
                + "wan ".repeat(nanpac % 5 % 2);
            if (i > 0) nanpanimi += "ale ";
            nanpai = nanpai % (100 ** i);
        }

        return nanpanimi;
    });

    eleventyConfig.addPairedShortcode("en", (insa) => insa.startsWith('\n') ? `::: attr {lang=en}\n${insa}\n:::` : `<span lang="en">${insa}</span>`);
    eleventyConfig.addPairedShortcode("sp", (insa) => insa.startsWith('\n') ? `::: attr {.sp lang=tok}\n${insa}\n:::` : `<span class="sp" lang="tok">${insa}</span>`);

    eleventyConfig.addPairedShortcode("split", (insa) => `<span class="split">\n${insa}\n</span>`);
    eleventyConfig.addPairedShortcode("splith", (insa, suli = 2) => `<h${suli} class="split">${insa}</h${suli}>`);
};
